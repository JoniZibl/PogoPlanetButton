<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>PogoPlanet Button (Web)</title>
<style>
  :root{
    --bg:#1F2A39;
    --bg2:#2C3D4E;
    --btn:#288164;
    --text:#E3E3E3;
    --muted:#C9D3DF;
    --warn:#F59E0B;
    --err:#EF4444;
    --ok:#22C55E;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:linear-gradient(180deg,var(--bg),var(--bg2) 70%);
    color:var(--text);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;
    font-weight:900; /* dicke prÃ¤gnante Schrift */
    letter-spacing:.2px;
  }
  .wrap{max-width:760px;margin:0 auto;padding:16px}
  .card{
    background:rgba(44,61,78,.75);
    border:1px solid rgba(233,239,246,.12);
    border-radius:16px;
    padding:16px;
    backdrop-filter: blur(6px);
  }
  h1{margin:0 0 12px;font-size:22px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input,button{
    height:48px;border-radius:12px;border:1px solid rgba(233,239,246,.18);
    background:#1C2A39;color:var(--text);padding:0 12px;font-size:16px;font-weight:900;
  }
  input::placeholder{color:#9fb0c0;font-weight:700}
  button.primary{
    background:var(--btn); border:none; color:var(--text);
    box-shadow: 0 4px 0 rgba(0,0,0,.25);
  }
  button.primary:active{transform:translateY(1px); box-shadow: 0 3px 0 rgba(0,0,0,.25)}
  button[disabled]{opacity:.55; filter:grayscale(.2)}
  .status{margin-top:8px;font-size:13px;color:var(--muted);display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#1C2A39;border:1px solid rgba(233,239,246,.15)}
  .dot{width:10px;height:10px;border-radius:999px;background:#8aa0b7}
  .ok{background:var(--ok)} .warn{background:var(--warn)} .err{background:var(--err)}
  .pad{
    user-select:none;-webkit-user-select:none;touch-action:none;
    height:58vh;min-height:320px;margin-top:14px;border-radius:18px;
    border:2px dashed rgba(233,239,246,.18);
    display:flex;align-items:center;justify-content:center;
    background: radial-gradient(900px 560px at 50% 10%, rgba(40,129,100,.30), transparent 60%), rgba(28,42,57,.75);
    font-size:30px;
  }
  .pad.holding{
    background: radial-gradient(900px 560px at 50% 10%, rgba(40,129,100,.55), transparent 60%), rgba(28,42,57,.95);
    border-color: rgba(40,129,100,.65);
  }
  .row2{display:flex;gap:8px;margin-top:10px}
  .row2 button{flex:1}
  .meta{display:flex;gap:10px;margin-left:auto}
  .id{opacity:.9}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ðŸŸ¢ PogoPlanet Button (Web)</h1>

    <div class="row">
      <input id="host" placeholder="HOST:PORT  (z. B. 192.168.0.23:8080)" style="flex:1"/>
      <button id="connect" class="primary">Verbinden</button>
    </div>

    <div class="status" id="statusRow">
      <span class="chip"><span id="dot" class="dot"></span><span id="status">Bereit. Host eintragen und verbinden.</span></span>
      <span class="chip">Ping: <span id="ping">â€“</span> ms</span>
      <span class="meta"><span class="chip id">ID: <span id="pid">â€“</span></span></span>
    </div>

    <div id="pad" class="pad">Halten zum Drehen</div>

    <div class="row2">
      <button id="restart" class="primary" disabled>Restart Level</button>
    </div>
  </div>
</div>

<script>
(() => {
  // ---------- UI ----------
  const elHost     = document.getElementById('host');
  const elConnect  = document.getElementById('connect');
  const elStatus   = document.getElementById('status');
  const elDot      = document.getElementById('dot');
  const elPad      = document.getElementById('pad');
  const elPid      = document.getElementById('pid');
  const elPing     = document.getElementById('ping');
  const btnRestart = document.getElementById('restart');

  // ---------- State ----------
  let ws = null;
  let host = localStorage.getItem('pogo_host') || '';
  let playerId = +(localStorage.getItem('pogo_id') || 0);
  let holding = false;
  let connected = false;

  // ping
  let pingTimer = null;
  let lastPingStamp = 0;

  // reconnect backoff
  let reconnectTimer = null;
  let backoffMs = 1000;       // start
  const BACKOFF_FACTOR = 1.7; // grows
  const BACKOFF_MAX = 10000;  // cap

  // init UI
  elHost.value = host;
  elPid.textContent = playerId || 'â€“';
  setStatus('Bereit. Host eintragen und verbinden.', null);

  function setStatus(text, color){
    elStatus.textContent = text;
    elDot.className = 'dot ' + (color || '');
  }

  function wsUrlFromHost(h){
    h = h.trim();
    if (!h) return '';
    if (h.startsWith('ws://') || h.startsWith('wss://')){
      if (!/\/ws(\b|\/|$)/.test(h)) h += '/ws';
      return h;
    }
    return `ws://${h}/ws`;
  }

  function enableControls(isConnected){
    connected = isConnected;
    btnRestart.disabled = !isConnected;
  }

  function safeSend(s){
    if (ws && ws.readyState === WebSocket.OPEN){
      try { ws.send(s); } catch {}
    }
  }

  // ---- Ping handling
  function startPing(){
    stopPing();
    pingTimer = setInterval(() => {
      if (!connected || !playerId) return;
      lastPingStamp = performance.now();
      safeSend(`PING;${playerId}`);
    }, 1500);
  }
  function stopPing(){
    if (pingTimer){ clearInterval(pingTimer); pingTimer = null; }
    elPing.textContent = 'â€“';
  }

  function scheduleReconnect(){
    clearTimeout(reconnectTimer);
    reconnectTimer = setTimeout(() => {
      if (host) connect(host);
    }, backoffMs);
    // increase backoff for next time
    backoffMs = Math.min(Math.floor(backoffMs * BACKOFF_FACTOR), BACKOFF_MAX);
    setStatus(`Getrennt. Neuer Verbindungsversuch in ${(backoffMs/1000).toFixed(1)}sâ€¦`, 'warn');
  }

  function resetBackoff(){
    backoffMs = 1000;
  }

  function connect(h){
    // close old
    if (ws){ try{ ws.close(); }catch{} ws = null; }
    stopPing();
    enableControls(false);

    host = h.trim();
    if (!host){ setStatus('Bitte HOST:PORT eingeben.', 'warn'); return; }
    localStorage.setItem('pogo_host', host);

    const url = wsUrlFromHost(host);
    setStatus(`Verbindeâ€¦ (${url})`, 'warn');

    try{
      ws = new WebSocket(url);
    }catch(e){
      setStatus('WebSocket konnte nicht erstellt werden.', 'err');
      scheduleReconnect();
      return;
    }

    ws.onopen = () => {
      resetBackoff();
      setStatus('Verbunden. Spieler prÃ¼fenâ€¦', 'ok');
      enableControls(true);
      if (!playerId) safeSend('JOIN');
      startPing();
    };

    ws.onclose = () => {
      enableControls(false);
      stopPing();
      scheduleReconnect();
    };

    ws.onerror = () => {
      setStatus('Verbindungsfehler. Host/Port prÃ¼fen.', 'err');
    };

    ws.onmessage = (ev) => {
      const msg = (ev.data || '').trim();
      if (!msg) return;

      if (msg.startsWith('OK;')){
        const id = +msg.split(';')[1];
        if (id > 0){
          playerId = id;
          localStorage.setItem('pogo_id', String(playerId));
          elPid.textContent = id;
          setStatus(`Verbunden â€¢ ID ${id}`, 'ok');
        }
        return;
      }

      if (msg.startsWith('PONG;')){
        if (lastPingStamp){
          const rtt = Math.max(0, Math.round(performance.now() - lastPingStamp));
          elPing.textContent = rtt;
          lastPingStamp = 0;
        }
        return;
      }

      if (msg === 'NEEDJOIN'){
        safeSend('JOIN');
        return;
      }
    };
  }

  function down(){
    if (!connected || !playerId) return;
    safeSend(`DOWN;${playerId}`);
  }
  function up(){
    if (!connected || !playerId) return;
    safeSend(`UP;${playerId}`);
  }

  // ---------- UI handlers ----------
  elConnect.onclick = () => connect(elHost.value);

  const press = (e)=>{ e.preventDefault(); if (!holding){ holding=true; elPad.classList.add('holding'); down(); } };
  const rel   = (e)=>{ e.preventDefault(); if (holding){ holding=false; elPad.classList.remove('holding'); up(); } };

  elPad.addEventListener('pointerdown', press);
  elPad.addEventListener('pointerup', rel);
  elPad.addEventListener('pointercancel', rel);
  elPad.addEventListener('pointerleave', rel);
  // Fallbacks
  elPad.addEventListener('touchstart', press, {passive:false});
  elPad.addEventListener('touchend', rel);
  elPad.addEventListener('mousedown', press);
  elPad.addEventListener('mouseup', rel);

  btnRestart.onclick = () => { if (connected) safeSend('RESTART'); };

  // lifecycle
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible'){
      // Sofort versuchen; Backoff bleibt gesetzt
      if (host && (!ws || ws.readyState !== WebSocket.OPEN)) connect(host);
    }
  });

  window.addEventListener('beforeunload', () => {
    try{ ws && ws.close(); }catch{}
  });

  // Auto-Verbinden falls Host gespeichert
  if (host) connect(host);
})();
</script>
</body>
</html>
